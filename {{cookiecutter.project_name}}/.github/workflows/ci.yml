name: Pytest, build docker image, push to GHCR

on: [pull_request, push]

concurrency:
  group: {% raw %}${{ github.workflow }}-${{ github.head_ref }}{% endraw %}
  cancel-in-progress: true

env:
  # https://github.com/pytest-dev/pytest/issues/2042#issuecomment-429289164
  PY_IGNORE_IMPORTMISMATCH: 1

jobs:
  pytest:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        deps:
          - label: Latest
            spec: ""
          - label: Minimum
            spec: >-
              python=3.9

      fail-fast: false
    name: {% raw %}${{ matrix.os }} â€¢ ${{ matrix.deps.label }}{% endraw %}
    runs-on: {% raw %}${{ matrix.os }}{% endraw %}
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: latest
          cache: true
      - name: Install
        run: |
          pixi install {% raw %}${{ matrix.deps.spec }}{% endraw %}
          pixi run pip install --no-deps .
      - name: Test
        run: |
          pixi run pytest -n0
